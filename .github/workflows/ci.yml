name: CI

on:
  push:
    branches: [master, main, develop]
  pull_request:
    branches: [master, main, develop]
  workflow_dispatch:

jobs:
  formatting:
    name: Code Formatting Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install formatters
        run: |
          # clang-format for C/C++
          sudo apt-get update
          sudo apt-get install -y clang-format

          # Python formatters
          pip install black isort

          # cmake-format
          pip install cmake-format

          # prettier for markdown/yaml/json
          npm install -g prettier

      - name: Install shfmt (shell formatter)
        uses: jaxxstorm/action-install-gh-release@v1
        with:
          repo: mvdan/sh
          tag: latest
          chmod: 0755

      - name: Install treefmt
        uses: jaxxstorm/action-install-gh-release@v1
        with:
          repo: numtide/treefmt
          tag: latest
          chmod: 0755

      - name: Check formatting
        run: treefmt --fail-on-change

  build-and-test:
    name: Build & Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        build_type: [Release]
        include:
          - os: ubuntu-latest
            build_type: Debug

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake \
            build-essential \
            libfftw3-dev \
            libsndfile1-dev

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install cmake fftw libsndfile

      - name: Install dependencies (Windows)
        if: runner.os == 'Windows'
        run: |
          choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System'

      - name: Configure CMake (Core Library)
        run: cmake -B build -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} -DOPENDAFF_BUILD_DAFF_TESTS=ON -DOPENDAFF_BUILD_DAFF_TOOL=OFF -DOPENDAFF_BUILD_DAFF_VIEWER=OFF -DOPENDAFF_WITH_DAFFVIZ=OFF

      - name: Build
        run: cmake --build build --config ${{ matrix.build_type }}

      - name: Run Core Tests
        working-directory: build
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            ./tests/verification/${{ matrix.build_type }}/VerificationTest.exe || exit 1
            ./tests/deserializertest/${{ matrix.build_type }}/DAFFFileBufferTest.exe || exit 1
          else
            ./tests/verification/VerificationTest || exit 1
            ./tests/deserializertest/DAFFFileBufferTest || exit 1
          fi
        shell: bash

      - name: Install
        run: cmake --install build --prefix install

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: opendaff-${{ matrix.os }}-${{ matrix.build_type }}
          path: install/

  build-with-viz:
    name: Build with Visualization (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake \
            build-essential \
            libfftw3-dev \
            libsndfile1-dev \
            qtbase5-dev \
            qttools5-dev \
            libqt5svg5-dev \
            libvtk9-dev

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install cmake fftw libsndfile qt@5 vtk

      - name: Configure CMake (with DAFFViz)
        run: cmake -B build -DCMAKE_BUILD_TYPE=Release -DOPENDAFF_WITH_DAFFVIZ=ON -DOPENDAFF_BUILD_DAFF_TOOL=ON -DOPENDAFF_BUILD_DAFF_TESTS=ON

      - name: Build
        run: cmake --build build --config Release

      - name: Run Tests
        working-directory: build
        run: |
          ./tests/verification/VerificationTest || exit 1
          ./tests/deserializertest/DAFFFileBufferTest || exit 1

  python-bindings:
    name: Python Bindings (${{ matrix.os }}, Python ${{ matrix.python-version }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ["3.8", "3.9", "3.10", "3.11", "3.12"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel

      - name: Build Python bindings
        working-directory: bindings/python
        run: |
          python setup.py build
          python setup.py install --user

      - name: Test Python import
        run: |
          python -c "import sys; sys.path.insert(0, 'python'); from DAFF import DAFF; print('DAFF import successful')"

      - name: Run Python example (if DAFF files exist)
        working-directory: bindings/python
        continue-on-error: true
        run: |
          python daff_example.py || echo "Example requires DAFF test files"

  go-bindings:
    name: Go Bindings (${{ matrix.os }}, Go ${{ matrix.go-version }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        go-version: ["1.20", "1.21", "1.22"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Go ${{ matrix.go-version }}
        uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go-version }}

      - name: Install build dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential

      - name: Install build dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install cmake

      - name: Install build dependencies (Windows)
        if: runner.os == 'Windows'
        run: |
          choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System'

      - name: Build DAFF library
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DOPENDAFF_WITH_GO_BINDING=ON
          cmake --build build --config Release

      - name: Build Go bindings
        working-directory: bindings/go
        run: |
          go build -v ./...

      - name: Run Go tests
        working-directory: bindings/go
        run: |
          go test -v ./...

      - name: Test Go module
        working-directory: bindings/go
        run: |
          go list -m all

  can-build-tools:
    name: Can Build DAFFTool & DAFFViewer
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install full dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake \
            build-essential \
            libfftw3-dev \
            libsndfile1-dev \
            qtbase5-dev \
            qttools5-dev \
            libqt5svg5-dev \
            libvtk9-dev

      - name: Configure with all applications
        run: cmake -B build -DCMAKE_BUILD_TYPE=Release -DOPENDAFF_WITH_DAFFVIZ=ON -DOPENDAFF_BUILD_DAFF_TOOL=ON -DOPENDAFF_BUILD_DAFF_VIEWER=ON -DOPENDAFF_BUILD_DAFF_TESTS=ON

      - name: Build all
        run: cmake --build build --config Release

      - name: Verify executables exist
        run: |
          test -f build/apps/tool/DAFFTool || exit 1
          test -f build/apps/viewer/DAFFViewer || exit 1
          echo "âœ“ DAFFTool and DAFFViewer built successfully"
